import { siteConfig } from '@/lib/config'
import { useGlobal } from '@/lib/global'
import { isBrowser, loadExternalResource } from '@/lib/utils'
import { useRouter } from 'next/router'
import { useEffect } from 'react'

const DEFAULT_TECH_GROW_JS = 'https://qiniu.techgrow.cn/readmore/dist/readmore.js'
const DEFAULT_TECH_GROW_CSS = 'https://qiniu.techgrow.cn/readmore/dist/hexo.css'
const DEFAULT_TECH_GROW_CAPTCHA_URL =
  'https://open.techgrow.cn/#/readmore/captcha/generate?blogId='

const hasValue = value => value !== undefined && value !== null && value !== ''

const getFirstConfig = (keys, defaultVal = null) => {
  for (const key of keys) {
    const value = siteConfig(key)
    if (hasValue(value)) {
      return value
    }
  }
  return defaultVal
}

const resolveCaptchaGenerateUrl = (url, blogId) => {
  if (!url) {
    return ''
  }

  if (!blogId) {
    return url
  }

  if (url.includes('{blogId}')) {
    return url.replace('{blogId}', blogId)
  }

  if (url.includes('blogId=')) {
    return url.replace(/blogId=([^&]*)/, `blogId=${blogId}`)
  }

  const separator = url.includes('?') ? '&' : '?'
  return `${url}${separator}blogId=${blogId}`
}

const getReadmoreWrapper = () =>
  document.getElementById('readmore-wrapper') ||
  document.getElementById('read-more-wrap')

const normalizePreviewHeight = height => {
  if (height === undefined || height === null || height === '') {
    return null
  }
  if (typeof height === 'number') {
    return `${height}px`
  }
  const raw = String(height).trim()
  if (!raw) {
    return null
  }
  if (raw.toLowerCase() === 'auto') {
    return null
  }
  return /^\d+$/.test(raw) ? `${raw}px` : raw
}
/**
 * 公众号导流插件（TechGrow）
 * @returns
 */
const TechGrow = () => {
  const router = useRouter()
  const qrcode = getFirstConfig(['TECH_GROW_QRCODE'], '请配置公众号二维码')
  const blogId = getFirstConfig(['TECH_GROW_BLOG_ID'])
  const name = getFirstConfig(['TECH_GROW_NAME'], '请配置公众号名')
  const id = getFirstConfig(
    ['TECH_GROW_ARTICLE_CONTENT_ID', 'TECH_GROW_CONTENT_ID'],
    'notion-article'
  )
  const keyword = getFirstConfig(['TECH_GROW_KEYWORD'], '请配置公众号关键词')
  const btnText = getFirstConfig(['TECH_GROW_BTN_TEXT'], '原创不易，完成人机检测，阅读全文')
  // 验证一次后的有效时长，单位小时
  const cookieAge = getFirstConfig(['TECH_GROW_VALIDITY_DURATION'], 1)
  const random = getFirstConfig(['TECH_GROW_RANDOM'], 1)
  const interval = getFirstConfig(['TECH_GROW_INTERVAL'], 60)
  const expires = getFirstConfig(['TECH_GROW_EXPIRES'], 365)
  const lockToc = getFirstConfig(['TECH_GROW_LOCK_TOC'], 'yes')
  const height = getFirstConfig(['TECH_GROW_HEIGHT'], 'auto')
  const tocSelector = getFirstConfig(['TECH_GROW_TOC_SELECTOR'], '')
  const debug = getFirstConfig(['TECH_GROW_DEBUG'], true)
  const allowMobile = getFirstConfig(['TECH_GROW_ALLOW_MOBILE'], false)
  // 白名单，想要放行的页面
  const whiteList = getFirstConfig(['TECH_GROW_WHITE_LIST'], '')
  // 黄名单，优先级最高，设置后只有这里的路径会被上锁，其他页面自动全部放行
  const yellowList = getFirstConfig(['TECH_GROW_YELLOW_LIST'], '')
  const jsUrl = getFirstConfig(['TECH_GROW_JS_URL'], DEFAULT_TECH_GROW_JS)
  const cssUrl = getFirstConfig(['TECH_GROW_CSS_URL'], DEFAULT_TECH_GROW_CSS)
  const captchaTemplateUrl = getFirstConfig(
    ['TECH_GROW_CAPTCHA_URL'],
    DEFAULT_TECH_GROW_CAPTCHA_URL
  )
  const captchaGenerateUrl = resolveCaptchaGenerateUrl(captchaTemplateUrl, blogId)
  const baseUrl = getFirstConfig(['TECH_GROW_BASE_URL'], '')

  // 登录信息
  const { isLoaded, isSignedIn } = useGlobal()

  const waitForContentReady = () =>
    new Promise(resolve => {
      let attempts = 0
      const maxAttempts = 20
      const timer = setInterval(() => {
        const target = document.getElementById(id)
        if (target && target.childElementCount > 0) {
          clearInterval(timer)
          resolve(true)
          return
        }
        attempts += 1
        if (attempts >= maxAttempts) {
          clearInterval(timer)
          resolve(false)
        }
      }, 200)
    })

  const loadReadmore = async () => {
    try {
      const isMobile = /phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone/i.test(
        navigator.userAgent
      )
      if (isMobile && !allowMobile) {
        if (debug) {
          console.log('Readmore: 移动端已禁用')
        }
        return
      }
      const isReady = await waitForContentReady()
      if (!isReady) {
        if (debug) {
          console.warn(`Readmore 未找到内容容器: #${id}`)
        }
        return
      }
      const target = document.getElementById(id)
      if (target) {
        const position = window.getComputedStyle(target).position
        if (!position || position === 'static') {
          // TechGrow 的 #readmore-wrapper 使用 absolute 定位，父容器需为 relative
          target.style.position = 'relative'
        }
      }
      if (cssUrl) {
        await loadExternalResource(cssUrl, 'css')
      }
      await loadExternalResource(jsUrl, 'js')
      const ReadmorePlugin = window?.ReadmorePlugin

      if (ReadmorePlugin) {
        const btw = new ReadmorePlugin()
        window.btw = btw
        btw.init({
          qrcode,
          id,
          name,
          btnText,
          keyword,
          blogId,
          cookieAge,
          random,
          interval,
          expires,
          lockToc,
          height,
          tocSelector,
          debug,
          execute: 'yes',
          type: 'hexo',
          baseUrl,
          captchaUrl: captchaGenerateUrl,
          generateCodeUrl: captchaGenerateUrl,
          codeUrl: captchaGenerateUrl
        })

        const fixReadmoreWrapperPosition = () => {
          const container = document.getElementById(id)
          const wrapper = getReadmoreWrapper()
          if (!container || !wrapper) {
            return false
          }

          if (wrapper.parentElement !== container) {
            container.appendChild(wrapper)
          }

          wrapper.style.position = 'absolute'
          wrapper.style.left = '0'
          wrapper.style.right = '0'
          wrapper.style.bottom = '0'
          wrapper.style.width = '100%'
          wrapper.style.zIndex = '9999'
          const previewHeight = normalizePreviewHeight(height)
          if (previewHeight) {
            // 只有在 readmore wrapper 已生成时才裁剪正文，避免误解锁
            container.style.height = previewHeight
            container.style.overflow = 'hidden'
          }
          return true
        }

        // 插件在不同模式下创建 wrapper 的时机不同，分批兜底修正
        ;[0, 150, 400, 900].forEach(delay => {
          setTimeout(() => {
            fixReadmoreWrapperPosition()
          }, delay)
        })

        return undefined
      } else {
        if (debug) {
          console.warn(`Readmore 插件加载成功但构造器不存在: ${jsUrl}`)
        }
      }
    } catch (error) {
      if (debug) {
        console.error('Readmore 加载异常', error)
      }
    }
  }

  useEffect(() => {
    const isInYellowList = isPathInList(router.asPath, yellowList)
    const isInWhiteList = isPathInList(router.asPath, whiteList)

    // 优先判断黄名单
    if (yellowList && yellowList.length > 0) {
      if (!isInYellowList) {
        console.log('当前路径不在黄名单中，放行')
        return
      }
    } else if (isInWhiteList) {
      // 白名单中，免检
      console.log('当前路径在白名单中，放行')
      return
    }

    if (isSignedIn) {
      // 用户已登录免检
      console.log('用户已登录，放行')
      return
    }

    if (process.env.NODE_ENV === 'development') {
      // 开发环境免检
      console.log('开发环境:屏蔽Readmore')
      return
    }

    if (isBrowser && blogId && !isSignedIn) {
      // 检查是否已加载
      const readMoreWrap = getReadmoreWrapper()
      if (!readMoreWrap) {
        loadReadmore()
      }
    }
  }, [isLoaded, router, id, tocSelector])

  return <></>
}

/**
 * 检查路径是否在名单中
 * @param {*} path 当前url的字符串
 * @param {*} listStr 名单字符串，逗号分隔
 */
function isPathInList(path, listStr) {
  if (!path || !listStr) {
    return false
  }

  // 提取 path 最后一个斜杠后的内容，并移除查询参数和 .html 后缀
  const processedPath = path
    .replace(/\?.*$/, '') // 移除查询参数
    .replace(/.*\/([^/]+)(?:\.html)?$/, '$1') // 提取最后部分

  const isInList = listStr.includes(processedPath)

  if (isInList) {
    // console.log(`当前路径在名单中: ${processedPath}`)
  }

  return isInList
}

export default TechGrow
